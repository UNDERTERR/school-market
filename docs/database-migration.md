# æ•°æ®åº“è¿ç§»è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®çš„æ•°æ®åº“è¿ç§»ç³»ç»Ÿæ”¯æŒï¼š
- âœ… ç°æœ‰æ•°æ®åº“çš„å®‰å…¨å‡çº§
- âœ… å¢é‡SQLè¿ç§»
- âœ… ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»šä¿æŠ¤
- âœ… è‡ªåŠ¨å¤‡ä»½æœºåˆ¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç°æœ‰æ•°æ®åº“åˆå§‹åŒ–

å¦‚æœæ‚¨çš„æ•°æ®åº“ä¸­å·²ç»æœ‰è¡¨ç»“æ„ï¼Œåªéœ€æ·»åŠ è¿ç§»æ”¯æŒï¼š

```bash
# åˆå§‹åŒ–è¿ç§»ç³»ç»Ÿï¼ˆä¸ä¼šåˆ›å»ºæ–°è¡¨ï¼‰
./scripts/migrate.sh init
```

### 2. è¿è¡Œè¿ç§»

```bash
# è¿è¡Œæ‰€æœ‰å¾…æ‰§è¡Œçš„è¿ç§»
./scripts/migrate.sh migrate

# å»ºè®®å…ˆå¤‡ä»½å†è¿ç§»
./scripts/migrate.sh backup && ./scripts/migrate.sh migrate
```

### 3. æŸ¥çœ‹çŠ¶æ€

```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
./scripts/migrate.sh status
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
scripts/database/
â”œâ”€â”€ äº”ä¸ªåˆå§‹åŒ–              # æ–°ç¯å¢ƒåˆå§‹åŒ–ï¼ˆåŒ…å«åŸºç¡€æ•°æ®ï¼‰
â”œâ”€â”€ migrate.sh            # è¿ç§»å·¥å…·è„šæœ¬
â”œâ”€â”€ migrations/           # å¢é‡è¿ç§»æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ *.sql            # æ—¶é—´æˆ³_æè¿°.sql æ ¼å¼çš„è¿ç§»æ–‡ä»¶
â””â”€â”€ backups/             # è‡ªåŠ¨å¤‡ä»½ç›®å½•ï¼ˆè¿è¡Œæ—¶åˆ›å»ºï¼‰
```

## ğŸ› ï¸ è¿ç§»å‘½ä»¤è¯¦è§£

| å‘½ä»¤ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `init` | åˆå§‹åŒ–æ•°æ®åº“å’Œè¿ç§»è¡¨ | æ–°ç¯å¢ƒæˆ–ç°æœ‰ç¯å¢ƒé¦–æ¬¡ä½¿ç”¨ |
| `migrate` | æ‰§è¡Œå¾…æ‰§è¡Œçš„è¿ç§» | æ—¥å¸¸æ•°æ®åº“å‡çº§ |
| `status` | æ˜¾ç¤ºè¿ç§»çŠ¶æ€ | æ£€æŸ¥å½“å‰çŠ¶æ€ |
| `create æè¿°` | åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶ | å¼€å‘æ–°åŠŸèƒ½ |
| `backup` | æ•°æ®åº“å¤‡ä»½ | è¿ç§»å‰å®‰å…¨æ“ä½œ |
| `validate` | éªŒè¯è¿ç§»å®Œæ•´æ€§ | ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥ |

## ğŸ“ è¿ç§»æ–‡ä»¶è§„èŒƒ

### å‘½åè§„åˆ™
```
{YYYYMMDD}_{HHMMSS}_{æè¿°}.sql
ä¾‹å¦‚ï¼š20240130_120000_add_order_tracking.sql
```

### æ–‡ä»¶å†…å®¹è§„èŒƒ
```sql
-- Migration: è¿ç§»æè¿°
-- Created: åˆ›å»ºæ—¶é—´
-- Version: ç‰ˆæœ¬å·
-- Description: è¯¦ç»†è¯´æ˜

-- SQLè¯­å¥
CREATE TABLE IF NOT EXISTS ...;
ALTER TABLE ...;
-- æ³¨æ„ï¼šä½¿ç”¨ IF NOT EXISTS é¿å…é‡å¤
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **ç°æœ‰æ•°æ®ä¿æŠ¤**
   - è‡ªåŠ¨æ£€æµ‹ç°æœ‰è¡¨ï¼Œé¿å…é‡å¤åˆ›å»º
   - ä½¿ç”¨ `IF NOT EXISTS` å®‰å…¨è¯­æ³•
   - å¤–é”®çº¦æŸçš„æ™ºèƒ½æ·»åŠ 

2. **å¤‡ä»½æœºåˆ¶**
   - è¿ç§»å‰è‡ªåŠ¨å¤‡ä»½
   - å¸¦æ—¶é—´æˆ³çš„å¤‡ä»½æ–‡ä»¶å‘½å
   - å®Œæ•´çš„SQLè½¬å‚¨æ–‡ä»¶

3. **ç‰ˆæœ¬æ§åˆ¶**
   - è¿ç§»ç‰ˆæœ¬è¿½è¸ª
   - æ–‡ä»¶æ ¡éªŒå’ŒéªŒè¯
   - é˜²æ­¢é‡å¤æ‰§è¡Œ

## ğŸ“Š CI/CD é›†æˆ

åœ¨ `.gitlab-ci.yml` ä¸­çš„ä½¿ç”¨ï¼š

```yaml
database-migration:
  stage: deploy
  script:
    - ./scripts/migrate.sh backup
    - ./scripts/migrate.sh migrate
    - ./scripts/migrate.sh validate
  artifacts:
    reports:
      junit: database-reports.xml
```

## âš¡ ç¯å¢ƒå˜é‡é…ç½®

```bash
# æ•°æ®åº“è¿æ¥
DB_HOST=localhost
DB_PORT=3306
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=school_market

# å¯é€‰ï¼šé€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¦†ç›–
./scripts/migrate.sh --host production-db --port 3306 migrate
```

## ğŸ”§ å¸¸è§åœºæ™¯

### åœºæ™¯1ï¼šå·²æœ‰ç”Ÿäº§æ•°æ®åº“
```bash
# 1. æ·»åŠ è¿ç§»æ”¯æŒ
./scripts/migrate.sh init

# 2. æŸ¥çœ‹å½“å‰çŠ¶æ€
./scripts/migrate.sh status

# 3. å¤‡ä»½å¹¶åº”ç”¨æ–°è¿ç§»
./scripts/migrate.sh backup
./scripts/migrate.sh migrate
```

### åœºæ™¯2ï¼šæ–°å¼€å‘ç¯å¢ƒ
```bash
# 1. å®Œæ•´åˆå§‹åŒ–ï¼ˆä¼šåˆ›å»ºè¡¨ç»“æ„ï¼‰
./scripts/migrate.sh init

# 2. åº”ç”¨å¼€å‘ä¸­çš„è¿ç§»
./scripts/migrate.sh migrate
```

### åœºæ™¯3ï¼šåˆ›å»ºæ–°åŠŸèƒ½è¿ç§»
```bash
# 1. åˆ›å»ºè¿ç§»æ–‡ä»¶
./scripts/migrate.sh create add_user_profile_field

# 2. ç¼–è¾‘ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
# 3. åº”ç”¨è¿ç§»
./scripts/migrate.sh migrate
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒ**ï¼šå§‹ç»ˆå…ˆæ‰§è¡Œ `backup` å‘½ä»¤
2. **è¿ç§»æ–‡ä»¶**ï¼šä½¿ç”¨å¹‚ç­‰SQLï¼ˆå¯é‡å¤æ‰§è¡Œï¼‰
3. **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ‰€æœ‰è¿ç§»æ–‡ä»¶éƒ½åº”æäº¤åˆ°ä»£ç ä»“åº“
4. **æµ‹è¯•**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»åå†åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ

## ğŸ“ é—®é¢˜æ’æŸ¥

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆï¼š

1. **è¡¨å·²å­˜åœ¨**
   - æ£€æŸ¥è¿ç§»æ–‡ä»¶æ˜¯å¦ä½¿ç”¨ `IF NOT EXISTS`
   - è¿è¡Œ `status` å‘½ä»¤æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€

2. **å¤–é”®çº¦æŸé”™è¯¯**
   - ç¡®ä¿å¼•ç”¨çš„è¡¨å’Œæ•°æ®å­˜åœ¨
   - æ£€æŸ¥å­—æ®µç±»å‹åŒ¹é…

3. **è¿æ¥å¤±è´¥**
   - éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
   - æ£€æŸ¥ç½‘ç»œè¿é€šæ€§

## ğŸ“š æ›´å¤šä¿¡æ¯

- æ•°æ®åº“è®¾è®¡æ–‡æ¡£ï¼š`docs/database-design.md`
- APIæ–‡æ¡£ï¼š`docs/api.md`
- éƒ¨ç½²æŒ‡å—ï¼š`docs/deployment.md`